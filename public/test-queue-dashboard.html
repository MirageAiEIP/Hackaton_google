<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Queue Dashboard Test</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .auth-section {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      input {
        flex: 1;
        min-width: 200px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
      }

      button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
      }

      .btn-login {
        background: #667eea;
        color: white;
      }

      .btn-login:hover {
        background: #5568d3;
      }

      .btn-connect {
        background: #48bb78;
        color: white;
      }

      .btn-connect:hover {
        background: #38a169;
      }

      .btn-disconnect {
        background: #f56565;
        color: white;
      }

      .btn-disconnect:hover {
        background: #e53e3e;
      }

      .btn-disabled {
        background: #cbd5e0;
        cursor: not-allowed;
      }

      .status {
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
        font-weight: 600;
      }

      .status.connected {
        background: #c6f6d5;
        color: #22543d;
      }

      .status.disconnected {
        background: #fed7d7;
        color: #742a2a;
      }

      .status.authenticating {
        background: #feebc8;
        color: #7c2d12;
      }

      .queue-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 15px;
      }

      .queue-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-left: 5px solid;
        transition: transform 0.2s;
      }

      .queue-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }

      .queue-card.P0 {
        border-left-color: #dc2626;
      }

      .queue-card.P1 {
        border-left-color: #ea580c;
      }

      .queue-card.P2 {
        border-left-color: #f59e0b;
      }

      .queue-card.P3 {
        border-left-color: #84cc16;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
      }

      .remove-btn {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #f56565;
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.2s;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .remove-btn:hover {
        background: #e53e3e;
        transform: scale(1.1);
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
      }

      .priority-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 12px;
        color: white;
      }

      .priority-badge.P0 {
        background: #dc2626;
      }
      .priority-badge.P1 {
        background: #ea580c;
      }
      .priority-badge.P2 {
        background: #f59e0b;
      }
      .priority-badge.P3 {
        background: #84cc16;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 11px;
      }

      .status-badge.WAITING {
        background: #fef3c7;
        color: #92400e;
      }

      .status-badge.CLAIMED {
        background: #dbeafe;
        color: #1e3a8a;
      }

      .status-badge.IN_PROGRESS {
        background: #d1fae5;
        color: #064e3b;
      }

      .complaint {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
        font-size: 15px;
      }

      .patient-info {
        color: #6b7280;
        font-size: 13px;
        margin-bottom: 8px;
      }

      .ai-summary {
        background: #f9fafb;
        padding: 8px;
        border-radius: 5px;
        font-size: 13px;
        margin: 8px 0;
        color: #374151;
        line-height: 1.4;
      }

      .symptoms {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin: 8px 0;
      }

      .symptom-tag {
        background: #e0e7ff;
        color: #3730a3;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 11px;
      }

      .red-flag {
        background: #fee2e2;
        color: #991b1b;
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
      }

      .waiting-time {
        font-size: 12px;
        color: #9ca3af;
        margin-top: 8px;
        text-align: right;
      }

      .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 10px;
        color: #9ca3af;
      }

      .empty-state h3 {
        margin-bottom: 10px;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: 10px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
      }

      .modal-header {
        padding: 20px;
        border-bottom: 2px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        color: #667eea;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
      }

      .close-modal:hover {
        color: #111827;
      }

      .modal-body {
        padding: 20px;
        overflow-y: auto;
        flex: 1;
      }

      .transcript-container {
        background: #f9fafb;
        border-radius: 8px;
        padding: 15px;
        min-height: 300px;
        max-height: 500px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 14px;
        line-height: 1.6;
      }

      .transcript-entry {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 5px;
      }

      .transcript-entry.user {
        background: #dbeafe;
        color: #1e3a8a;
      }

      .transcript-entry.agent {
        background: #d1fae5;
        color: #064e3b;
      }

      .transcript-empty {
        text-align: center;
        color: #9ca3af;
        padding: 40px;
      }

      .cursor {
        cursor: pointer;
      }

      .queue-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🚨 SAMU Queue Dashboard - Test Client</h1>

        <div class="auth-section">
          <input type="text" id="employeeId" placeholder="Employee ID" value="OP001" />
          <input type="password" id="password" placeholder="Password" value="SecureOp123!" />
          <button class="btn-login" onclick="login()">Login</button>
          <button class="btn-connect btn-disabled" id="connectBtn" onclick="connect()" disabled>
            Connect to Queue
          </button>
          <button class="btn-disconnect btn-disabled" id="disconnectBtn" onclick="disconnect()" disabled>
            Disconnect
          </button>
        </div>

        <div id="status" class="status disconnected">🔴 Disconnected</div>
      </div>

      <div class="queue-grid" id="queueGrid">
        <div class="empty-state">
          <h3>No active calls</h3>
          <p>Connect to the WebSocket to see real-time queue updates</p>
        </div>
      </div>
    </div>

    <div class="modal" id="transcriptModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Transcription en direct</h2>
          <button class="close-modal" onclick="closeTranscriptModal()">×</button>
        </div>
        <div class="modal-body">
          <div class="transcript-container" id="transcriptContainer">
            <div class="transcript-empty">Chargement de la transcription...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      let ws = null;
      let accessToken = null;
      let queueData = new Map();

      async function login() {
        const employeeId = document.getElementById('employeeId').value;
        const password = document.getElementById('password').value;

        const statusEl = document.getElementById('status');
        statusEl.className = 'status authenticating';
        statusEl.textContent = '🔄 Authenticating...';

        try {
          const response = await fetch('http://localhost:8080/api/v1/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ employeeId, password }),
          });

          if (!response.ok) {
            throw new Error('Login failed');
          }

          const data = await response.json();
          accessToken = data.accessToken;

          statusEl.className = 'status disconnected';
          statusEl.textContent = '✅ Authenticated - Ready to connect';

          document.getElementById('connectBtn').disabled = false;
          document.getElementById('connectBtn').classList.remove('btn-disabled');

          console.log('Login successful', data);
        } catch (error) {
          statusEl.className = 'status disconnected';
          statusEl.textContent = '❌ Authentication failed: ' + error.message;
          console.error('Login error:', error);
        }
      }

      function connect() {
        if (!accessToken) {
          alert('Please login first');
          return;
        }

        const statusEl = document.getElementById('status');
        statusEl.className = 'status authenticating';
        statusEl.textContent = '🔄 Connecting...';

        ws = new WebSocket(`ws://localhost:8080/ws/queue-dashboard?token=${accessToken}`);

        ws.onopen = () => {
          statusEl.className = 'status connected';
          statusEl.textContent = '🟢 Connected to Queue Dashboard';
          document.getElementById('connectBtn').disabled = true;
          document.getElementById('connectBtn').classList.add('btn-disabled');
          document.getElementById('disconnectBtn').disabled = false;
          document.getElementById('disconnectBtn').classList.remove('btn-disabled');
          console.log('WebSocket connected');
        };

        ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          console.log('Received message:', message);
          handleMessage(message);
        };

        ws.onclose = () => {
          statusEl.className = 'status disconnected';
          statusEl.textContent = '🔴 Disconnected';
          document.getElementById('connectBtn').disabled = false;
          document.getElementById('connectBtn').classList.remove('btn-disabled');
          document.getElementById('disconnectBtn').disabled = true;
          document.getElementById('disconnectBtn').classList.add('btn-disabled');
          console.log('WebSocket disconnected');
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          statusEl.className = 'status disconnected';
          statusEl.textContent = '❌ Connection error';
        };
      }

      function disconnect() {
        if (ws) {
          ws.close();
          ws = null;
        }
      }

      function handleMessage(message) {
        switch (message.type) {
          case 'queue:initial':
            queueData.clear();
            message.data.forEach((entry) => {
              queueData.set(entry.id, entry);
            });
            renderQueue();
            break;

          case 'queue:added':
            queueData.set(message.data.id, message.data);
            renderQueue();
            break;

          case 'queue:updated':
            const existingEntry = queueData.get(message.data.id);
            if (existingEntry) {
              Object.assign(existingEntry, message.data);
              renderQueue();
            }
            break;

          case 'queue:removed':
            queueData.delete(message.data.id);
            renderQueue();
            break;

          case 'queue:transcript-updated':
            // Update transcript in modal if it's open and for the same call
            if (currentSubscribedCallId === message.data.callId) {
              renderTranscript(message.data.transcript);
            }
            break;

          case 'queue:pong':
            console.log('Pong received:', message.timestamp);
            break;

          case 'queue:error':
            alert('Error: ' + message.error.message);
            console.error('Queue error:', message.error);
            break;

          default:
            console.warn('Unknown message type:', message.type);
        }
      }

      function renderQueue() {
        const grid = document.getElementById('queueGrid');

        if (queueData.size === 0) {
          grid.innerHTML = `
            <div class="empty-state">
              <h3>✅ No active calls</h3>
              <p>Queue is empty - waiting for new calls</p>
            </div>
          `;
          return;
        }

        // Sort by priority (P0 first) then by waiting time
        const entries = Array.from(queueData.values()).sort((a, b) => {
          const priorityOrder = { P0: 0, P1: 1, P2: 2, P3: 3 };
          if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
            return priorityOrder[a.priority] - priorityOrder[b.priority];
          }
          return new Date(a.waitingSince) - new Date(b.waitingSince);
        });

        grid.innerHTML = entries.map((entry) => renderCard(entry)).join('');
      }

      function renderCard(entry) {
        const waitingMinutes = Math.floor(entry.waitingTimeSeconds / 60);
        const waitingDisplay =
          waitingMinutes < 1 ? '< 1 min' : waitingMinutes === 1 ? '1 min' : `${waitingMinutes} mins`;

        return `
          <div class="queue-card ${entry.priority}" onclick="openTranscriptModal('${entry.callId}')">
            <button class="remove-btn" onclick="event.stopPropagation(); removeFromQueue('${entry.id}')" title="Retirer de la queue">
              ×
            </button>
            <div class="card-header">
              <span class="priority-badge ${entry.priority}">${entry.priority}</span>
              <span class="status-badge ${entry.status}">${entry.status}</span>
            </div>

            <div class="complaint">${entry.chiefComplaint}</div>

            <div class="patient-info">
              ${entry.patientAge ? `Age: ${entry.patientAge}` : 'Age: N/A'} •
              ${entry.patientGender || 'N/A'} •
              ${entry.location || 'Location unknown'}
            </div>

            <div class="ai-summary">
              <strong>AI Summary:</strong> ${entry.aiSummary}
            </div>

            <div class="ai-summary">
              <strong>Recommendation:</strong> ${entry.aiRecommendation}
            </div>

            ${
              entry.keySymptoms && entry.keySymptoms.length > 0
                ? `<div class="symptoms">
                    ${entry.keySymptoms.map((s) => `<span class="symptom-tag">${s}</span>`).join('')}
                  </div>`
                : ''
            }

            ${
              entry.redFlags && entry.redFlags.length > 0
                ? `<div class="symptoms">
                    ${entry.redFlags.map((f) => `<span class="red-flag">${f}</span>`).join('')}
                  </div>`
                : ''
            }

            ${
              entry.claimedBy
                ? `<div class="patient-info" style="margin-top: 8px;">
                    Claimed by: ${entry.claimedBy}
                  </div>`
                : ''
            }

            <div class="waiting-time">Waiting: ${waitingDisplay}</div>
          </div>
        `;
      }

      let currentSubscribedCallId = null;

      async function openTranscriptModal(callId) {
        const modal = document.getElementById('transcriptModal');
        const title = document.getElementById('modalTitle');

        title.textContent = `Transcription - Call ${callId}`;
        modal.classList.add('active');

        // Show loading state
        document.getElementById('transcriptContainer').innerHTML = `
          <div class="transcript-empty">
            Chargement de la transcription...
          </div>
        `;

        // Subscribe to transcript updates via WebSocket
        // The server will send the current transcript immediately upon subscription
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'queue:subscribe-transcript',
            callId: callId
          }));
          currentSubscribedCallId = callId;
        } else {
          document.getElementById('transcriptContainer').innerHTML = `
            <div class="transcript-empty">
              ❌ WebSocket non connecté. Veuillez vous reconnecter.
            </div>
          `;
        }
      }

      function closeTranscriptModal() {
        const modal = document.getElementById('transcriptModal');
        modal.classList.remove('active');

        // Unsubscribe from transcript updates
        if (ws && ws.readyState === WebSocket.OPEN && currentSubscribedCallId) {
          ws.send(JSON.stringify({
            type: 'queue:unsubscribe-transcript',
            callId: currentSubscribedCallId
          }));
          currentSubscribedCallId = null;
        }
      }

      async function removeFromQueue(queueEntryId) {
        if (!confirm('Êtes-vous sûr de vouloir retirer cette entrée de la queue ?')) {
          return;
        }

        try {
          const response = await fetch(`http://localhost:8080/api/v1/queue/${queueEntryId}/status`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
              status: 'ABANDONED'
            })
          });

          if (!response.ok) {
            throw new Error('Échec de la suppression');
          }

          console.log('Entry removed from queue:', queueEntryId);

          // La mise à jour sera automatiquement gérée par le WebSocket
          // qui recevra un message queue:removed
        } catch (error) {
          console.error('Error removing from queue:', error);
          alert('Erreur lors du retrait de la queue. Veuillez réessayer.');
        }
      }

      function renderTranscript(transcript) {
        const container = document.getElementById('transcriptContainer');

        if (!transcript || transcript.trim() === '') {
          container.innerHTML = `
            <div class="transcript-empty">
              Aucune transcription disponible pour le moment.<br>
              L'appel est en cours...
            </div>
          `;
          return;
        }

        const lines = transcript.split('\n').filter(line => line.trim() !== '');

        if (lines.length === 0) {
          container.innerHTML = `
            <div class="transcript-empty">
              Aucune transcription disponible pour le moment.<br>
              L'appel est en cours...
            </div>
          `;
          return;
        }

        let html = '';
        lines.forEach(line => {
          const isUser = line.toLowerCase().includes('user:') || line.toLowerCase().includes('patient:') || line.toLowerCase().includes('caller:');
          const isAgent = line.toLowerCase().includes('agent:') || line.toLowerCase().includes('assistant:');
          const isOperator = line.toLowerCase().includes('operator:');

          if (isUser) {
            html += `<div class="transcript-entry user">${line}</div>`;
          } else if (isAgent) {
            html += `<div class="transcript-entry agent">${line}</div>`;
          } else if (isOperator) {
            html += `<div class="transcript-entry agent" style="background: #fef3c7; color: #92400e;">${line}</div>`;
          } else {
            html += `<div class="transcript-entry">${line}</div>`;
          }
        });

        container.innerHTML = html;
        container.scrollTop = container.scrollHeight;
      }

      // Auto-connect on page load if we have credentials
      window.addEventListener('load', () => {
        console.log('Queue Dashboard Test Client loaded');
      });
    </script>
  </body>
</html>
